package visitor;

import java.io.File;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.regex.*;
import java.util.Vector;
import org.w3c.dom.*;
import learning.Model;
import learning.Utilities;

/**
 * <p>Title: XML Hierarchy Using Visitor Pattern</p>
 * <p>Description: The composite class in the Composite Pattern</p>
 * <p>Copyright: Copyright (c) 2004</p>
 * <p>Company: </p>
 * @author Hong Cui
 * @version 1.0
 * @todo placeholders for answers???
 */

public class ElementComposite
    extends ElementComponent {
  protected int type = 0;
  protected Model learnedmodel = null;
  /**
   * assume xml is at least well formed
   * @param xml
   */
  public ElementComposite(String xml, String fname, boolean train) {
    super(xml, fname, train);
  }

  public ElementComposite() {
    super();
  }

  /**
   * convert a ElementLeaf to a ElementComposite
   * @param el
   */
  public ElementComposite(ElementComponent el) {
    this.children = new ArrayList();
    this.trainingexamples = el.getTrainingExamples();
    this.markeds = el.getMarkeds();
    this.answers = el.getAnswers();
    this.tag = el.getTag();
    this.parent = el.getParent();
    el.getParent().addChild(this);
    el.getParent().removeChild(el);
  }

  /**
   * Add an ElementComponent to the children
   * @param e An ElementComponent to be added to the children
   * @return ture, if e is added, otherwise false
   */
  public boolean addChild(ElementComponent e) {
    if (e != null) {
      children.add(e);
      return true;
    }
    return false;
  }

  public Iterator iterator() {
    return children.iterator();
  }

  /**
   * Remove an ElementComponent from the children
   * @param e An ElementComponent to be removed from the children
   * @return ture, if e is removed, otherwise false
   */
  public boolean removeChild(ElementComponent e) {
    if (e != null) {
      children.remove(e);
      return true;
    }
    return false;
  }

  /**
   * find in the children an elementcomponent with tag
   * @param tag
   * @return null if not found, otherwise return the elementcomponent
   */
  public ElementComponent findChild(String tag) {
    ElementComponent ec = null;
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ec = (ElementComponent) it.next();
      if (ec.getTag().toLowerCase().compareTo(tag.toLowerCase()) == 0) {
        return ec;
      }
    }
    return null;
  }

  /**
   * after learning strategy is applied to learn a model for the component, save it to the component
   * @param m
   */
  public void setModel(Model m) {
    learnedmodel = m;
  }

  public Object getModel() {
    return learnedmodel;
  }

  /**
   * piece up to return complete marked up examples from children
   * recursion, each node collects the marked up pieces from its children and fixes them in original order
   * because it's possible to have one elements occurring multiple times in xml, it's possible for a node to
   * have more than one pieced-ups. that's the reason for return an array.
   *
   * @return
   */
  public String[] getMarked(int index) {
    Hashtable count = new Hashtable();
    Vector ordered = (Vector) markeds.get(index);
    Enumeration en = ordered.elements();
    StringBuffer[] marked = new StringBuffer[ordered.size()];
    int c = 0;
    while (en.hasMoreElements()) {
      marked[c] = new StringBuffer();
      marked[c].append("<" + tag + ">");
      String seg = (String) en.nextElement();
      boolean succeed = false; //if sub-elements are marked successfully
      //when false, tagorder is empty
      Iterator tagorder = Utilities.getTagOrder(seg); //a list of subelem tags in orig. order
      while (tagorder.hasNext()) {
        succeed = true;
        String tag = (String) tagorder.next();
        if (count.containsKey(tag)) {
          count.put(tag,
                    new Integer( ( (Integer) count.get(tag)).intValue() + 1));
        }
        else {
          count.put(tag, new Integer(1));
        }
        Iterator it = children.iterator(); //child nodes
        while (it.hasNext()) {
          ElementComponent ec = (ElementComponent) it.next();
          if (tag.compareTo(ec.getTag()) == 0) {
            marked[c].append(ec.getMarked(index)[ ( (Integer) count.get(tag)).
                             intValue() - 1]);
            break;
          }
        }
      }
      if (succeed == false) {
        marked[c].append(seg); //seg is not marked further, just return seg itself
      }
      marked[c].append("</" + tag + ">");
      c++;
    }

    String[] result = new String[marked.length];
    for (int i = 0; i < marked.length; i++) {
      result[i] = marked[i].toString();
    }
    return result;
  }

  /**
   * adjust markeds to reflect the correction/insertion to children's markeds
   * @param markeds
   * @param order
   */
  public void adjustMarkeds(Vector markeds, int order, String tag) {
    Vector p = (Vector)this.markeds.get(order);
    Enumeration men = markeds.elements();
    while (men.hasMoreElements()) {
      String mstring = (String) men.nextElement();
      Enumeration pen = p.elements();
      int count = 0;
      while (pen.hasMoreElements()) {
        String pstring = (String) pen.nextElement();
        if (pstring.replaceAll("\\s+",
                               "").indexOf(mstring.replaceAll("\\s+", "")) >= 0) {
          pstring = adjust(pstring, mstring, tag);
          p.set(count, pstring);
          break;
        }
        count++;
      }
    }
  }

  /**
   * not need to adjust markedsegs, they are merely the entire content of the element
   * @param markedsegs
   * @param order
   */
  /* public void adjustMarkedSegs(Vector markedsegs, int order, String tag) {
     Vector p = (Vector)this.markedsegs.get(order);
     Enumeration men = markedsegs.elements();
     while (men.hasMoreElements()) {
       String mstring = ( (MarkedSegment) men.nextElement()).getSegment();
       Enumeration pen = p.elements();
       while (pen.hasMoreElements()) {
         MarkedSegment pseg = (MarkedSegment) pen.nextElement();
         String pstring = pseg.getSegment();
         if (pstring.replaceAll("\\s+",
       "").indexOf(mstring.replaceAll("\\s+", "")) >= 0) {
           pstring = adjust(pstring, mstring, tag);
           pseg.setSegment(pstring);
           break;
         }
       }
     }
   }*/

  /**
   * replace mstring in pstring with <tag>mstring</tag>, and close/start neighboring elements
   *
   *
   * @param pstring
   * @param mstring
   * @return
   */
  private String adjust(String pstring, String mstring, String tag) {
    String newstring = "";
    String mstr = mstring.replaceAll("\\s+", " ").replaceAll("\\s*,\\s*", ", ").
        replaceAll("\\s*\\.\\s*", "\\\\. ").replaceAll("\\s*;\\s*", "; ").
        replaceAll("\\s*\\(\\s", " \\\\(").replaceAll("\\s*\\)\\s*", "\\\\) ").
        replaceAll("\\s*\\[\\s*",
                   " \\\\[").
        replaceAll("\\s*\\]\\s*", "\\\\] ").replaceAll("\\s*\\?\\s*", "\\\\? ").
        replaceAll("\\s*=\\s*",
                   "=").replaceAll("\\s*-\\s*", "\\\\-");
    String pstr = pstring.replaceAll("\\s+", " ").replaceAll("\\s*,\\s*", ", ").
        replaceAll("\\s*\\.\\s*", ". ").replaceAll("\\s*;\\s*", "; ").
        replaceAll("\\s*\\(\\s", " (").replaceAll("\\s*\\)\\s*", ") ").
        replaceAll("\\s*\\[\\s*",
                   " [").
        replaceAll("\\s*\\]\\s*", "] ").replaceAll("\\s*\\?\\s*", "? ").
        replaceAll("\\s*=\\s*",
                   "=").replaceAll("\\s*-\\s*", "-");

    Pattern p = Pattern.compile("(.*?)" + mstr + "([^<]*?</(.*?)>.*)");
    Matcher m = p.matcher(pstr);
    while (m.lookingAt()) {
      String etag = m.group(3);
      pstr = m.group(2);
      newstring = m.group(1) + "</" + etag + ">" + "<" + tag + ">" +
          mstr.replaceAll("\\\\", "") +
          "</" + tag + "><" + etag + ">";
      m = p.matcher(pstr);
    }
    newstring += pstr;
    if (newstring.compareTo(pstr) == 0) {
      System.err.println("adjust parent's marked failed");
    }
    newstring = newstring.replaceAll("<(.*?)>\\s*</\\1>", "");
    return newstring;
  }

  public void addAnswerExample(String xml) {
    answers.add(Utilities.getFlatXml(xml).toString());
  }

  /**
   * collaps xml into a flat well-formed xml 1 level deep, and add it to trainingexamples
   * @param xml
   */
  public void addTrainingExample(String xml, String filename) {
    String gfname = "";
    Pattern g = Pattern.compile(".*?g_(\\w+?)[\\._].*");
    Pattern f = Pattern.compile(".*?f_(\\w+?)[\\._].*");
    Matcher m = g.matcher(filename);
    if (m.lookingAt()) {
      gfname = m.group(1);
    }
    else {
      m = f.matcher(filename);
      if (m.lookingAt()) {
        gfname = m.group(1);
      }
      else {
        gfname = filename; //if filename is already f/g name
      }
    }
    String flat = markNonspecified(Utilities.getFlatXml(xml));//non-specified may be tagged to a leaf element of an xml instance, because the element was earlier created as a composite element
    trainingexamples.add(flat);
    if (trainfilenames.containsKey(gfname)) {
      ( (ArrayList) trainfilenames.get(gfname)).add(flat);
    }
    else {
      ArrayList exps = new ArrayList();
      exps.add(flat);
      trainfilenames.put(gfname, exps);
    }
  }

  /**
   * extract immediate child elements and add them to the arraylist children
   * @param xml the xml string to be added
   * @param train is this xml training data(true) or test data/answer(false)
   */
  public void populateChildren(String xml, String fname, boolean train) {
    Document document = Utilities.getDomModel(xml);
    //extract elements at current level, make each elements a child ElementComponent
    Node root = document.getDocumentElement();
    tag = root.getNodeName();
    for (Node achild = root.getFirstChild(); achild != null;
         achild = achild.getNextSibling()) {
      if (achild.getNodeType() == Node.ELEMENT_NODE) {
        String childtext = achild.toString(); //content of achild "<achild>.*?</achild>"
        //String childtext = achild.getTextContent();
        if (childtext != null && childtext.compareTo("") != 0) {
          //if achild exists as a child comp to THIS, addTrainingExample, otherwise, create a new child
          ElementComponent ec = this.findChild(achild.getNodeName());
          if (ec == null) { //create new
            ec = hasGrandChildren(achild) ?
                (ElementComponent)new ElementComposite(childtext, fname, train) :
                new ElementLeaf(childtext, fname, train);
            //ec = (ElementComponent)new ElementComposite(childtext, train);
            ec.setParent(this);
            this.addChild(ec);
          }
          else { //add to trainingexamples
            if (train) {
              ec.addTrainingExample(childtext, fname);
            }
            else {
              ec.addAnswerExample(childtext);
            }
            if (ec instanceof ElementComposite) { //if ec is a composite
              ec.populateChildren(childtext, fname, train);
            }
            else { //if ec is a leaf
              //if achild embeds other elements, need to
              //convert ec from leaf to composite
              if (hasGrandChildren(achild)) {
                ElementComponent newec = new ElementComposite(ec);
                newec.populateChildren(childtext, fname, train);
              }
            }
          }
          //ec.populateChildren(childtext, train);
        }
      }
      else { //non-Element node
        String nonspecified = achild.getNodeValue();
        if (nonspecified != null && nonspecified.trim().compareTo("") != 0) {
          //make a non-empty non-specified element for non-specified or pcdata
          ElementLeaf et = (ElementLeaf)this.findChild(Model.nonspecified);
          nonspecified = "<" + Model.nonspecified + ">" +
              nonspecified.replaceAll("^\\s+", "").replaceAll("\\s+$", "") +
              "</" + Model.nonspecified + ">";
          if (et == null) {
            et = new ElementLeaf(nonspecified, fname, train);
            et.setParent(this);
            this.addChild(et);
          }
          else {
            if (train) {
              et.addTrainingExample(nonspecified, fname);
            }
            /*else {
              et.addAnswer(nonspecified);
                         }*/
          }
        }
      }
    }

  }

  public static String markNonspecified(String example) {
    String leftangel = "<";
    String rightangel = ">";
    String leftangelend = "</";
    StringBuffer sb = new StringBuffer();
    Pattern p = Pattern.compile("(.*?)(<(.*?)>.*?</\\3>)(.*)");
    Matcher m = p.matcher(example);
    while (m.lookingAt()) {
      /*sb.append(m.group(1).trim().compareTo("") != 0 ?
                "<" + Model.nonspecified + ">" + m.group(1).trim() + "</" +
                Model.nonspecified + ">" : "");*/
      if(m.group(1).trim().compareTo("") != 0){
        sb.append(leftangel).append(Model.nonspecified).append(rightangel).
            append(m.group(1).trim()).append(leftangelend).
            append(Model.nonspecified).append(rightangel);
      }
      sb.append(m.group(2));
      example = m.group(4);
      m = p.matcher(example);
    }
    if (example.trim().compareTo("") != 0) {
      sb.append(leftangel).append(Model.nonspecified).append(rightangel).append(example).append(leftangelend).
         append(Model.nonspecified).append(rightangel);
    }
    return sb.toString();
  }

  /**
   * test to see if any of anode's children has children
   * @param anode
   * @return true or false
   */
  private boolean hasGrandChildren(Node anode) {
    for (Node n = anode.getFirstChild(); n != null; n = n.getNextSibling()) {
      if (n.getChildNodes().getLength() > 0) {
        return true;
      }
    }
    return false;
  }

  /**
   * print the component and all its children
   */
  public void print() {
    System.out.println("<" + tag + ">");
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent ec = (ElementComponent) it.next();
      ec.print();
    }
    System.out.println("</" + tag + ">");
  }

  public void accept(ReflectiveVisitor visitor, String alg) {
    visitor.dispatch(this, alg);
  }

  /**
   * child classes of this
   * @return
   */
  public ArrayList getChildClasses() {
    ArrayList classes = new ArrayList();
    Iterator it = children.iterator();
    while (it.hasNext()) {
      classes.add(getParentTags() + "/" +
                  ( (ElementComponent) it.next()).getTag());
    }
    return classes;
  }

  /**
   * get all tags of all children nodes, plus the tag of this node
   * @return
   */
  public ArrayList getAllClasses() {
    ArrayList classes = new ArrayList();
    Iterator it = children.iterator();
    classes.add(getParentTags() + "/" + tag);
    while (it.hasNext()) {
      classes.addAll( ( (ElementComponent) it.next()).getAllClasses());
    }
    return classes;
  }

  /**
   * get scores of immediate children
   * @return
   */
  public ArrayList getChildScores() {
    ArrayList scores = new ArrayList();
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent ec = (ElementComponent) it.next();
      String size = "" + ec.getTrainingExamples().size();
      scores.add(new MapEntry(ec.getTag(), ec.getScore(), size));
    }
    return scores;
  }

  /**
   * get scores of all child nodes of this branch
   * @return
   */
  public ArrayList getAllScores() {
    ArrayList scores = new ArrayList();
    String size = "" + trainingexamples.size();
    scores.add(new MapEntry(getParentTags() + "/" + tag, score, size));
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent ec = (ElementComponent) it.next();
      scores.addAll(ec.getAllScores());
    }
    return scores;
  }

  /**
   * reset scores of all children and this
   */
  public void resetScores() {
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent child = (ElementComponent) it.next();
      child.resetScores();
    }
    this.score = null;
  }

  /**
   * reset  of all children and this
   */
  public void resetAnswers() {
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent child = (ElementComponent) it.next();
      child.resetAnswers();
    }
    this.answers = new ArrayList();
  }

  public void resetTrains() {
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent child = (ElementComponent) it.next();
      child.resetTrains();
    }
    this.trainingexamples = new ArrayList();
    this.trainfilenames = new Hashtable();
  }

  /**
   * reset  of all children and this
   */
  public void resetMarkeds() {
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent child = (ElementComponent) it.next();
      child.resetMarkeds();
    }
    this.markeds = new ArrayList();
  }

  public void resetMarkedSegs() {
    Iterator it = children.iterator();
    while (it.hasNext()) {
      ElementComponent child = (ElementComponent) it.next();
      child.resetMarkedSegs();
    }
    this.markedsegs = new ArrayList();
  }

  /**
   *
   * @param args args[0]=dir--the source where the model will be learned
   *             args[1]=algorithm to be used. choose from NB, CT, LW, LWI, SC,
   *                     SCCP, SCCPI, SMCP, SMCPI
   */
  public static void main(String[] args) {
    String string = "example: java.lang.String = "<unclassified>[0] Oogamous chlorophyte algal group with gametangia surrounded by a multicellular cover and verticillate thallus made of alternating giant coenocytic cells and short uninucleate nodal cells where whorls of branchlets originate.
[1] Abrupt downward turning and thinning producing circular furrow around expanded ends of spirals (PECK, 1957).
[2] Summit truncated.
[3] The artificiality of this taxon has been discussed by L. GRAMBAST (1957), and it is no longer acknowledged.
[4] Genus monotypic.
[5] Genus monotypic.
[6] Numerous accessory pores present, with units of outer layer of utricle radiating from them.
[7] Internal nodular layer of utricle well developed.
[8] Internal nodular layer of utricle well developed.
[9] Loss of operculum creates rose-shaped apex opening.
[10] Internal cellular folds present.
[11] Internal cellular folds present.
[12] Internal cellular folds absent.
[13] Long vertical units bifurcating into 2 secondary parts.</unclassified><main-part>[0] Main part found as fossils is female fructification (gyrogonite), representing oogonium that contained egg;
[0] resistant oospore (zygote) membrane made of sporopollenin and more or less calcified enveloping tube cells and basal plate.</main-part><antheridium>[0] Antheridia, preserved as casts, rarely represented, and remains of thallus generally fragmentary and not taxonomically significant.</antheridium><classification-based>[0] Classification based mainly on gyrogonite.</classification-based><description>[0] Description as for phylum.</description><apical-structure>[0] Apical structure variable.</apical-structure><gyrogonite>[0] Gyrogonite with 5 sinistrally spiralled cells, not enclosed in utricle;
[1] Gyrogonite oblate to oblate-spheroidal;
[2] Gyrogonite subovoidal, apex truncated or broadly rounded, base forming narrow, projecting cone or columnar shaped;
[3] Gyrogonite subprolate to prolate spheroidal with apex rounded or forming short neck;
[4] Gyrogonites with 5 sinistrally spiralled cells, not enclosed in utricle;
[5] Gyrogonite of Porocharaceae with apical part drawn into neck that is conical or truncated at distal end;
[6] Gyrogonite with 5 sinistrally spiralled cells, not enclosed in utricle;
[7] Gyrogonites with 7 to 12 dextrally spiralled cells, without transverse ridges;
[8] Gyrogonites with 8 to 12 dextrally spiralled cells, with no coronula cells;
[0] spiral cells joined at apex along a broken line.
[1] spiral cell endings delimit an apical pore generally open, although pore tends to be closed in some stellatocharoid genera.
[0] Gyrogonite of Characeae with undivided basal plate, except Aclistochara.
[1] Gyrogonites unornamented.
[2] Gyrogonite of Characeae with basal plate multipartite, except in Sphaerochara where basal plate is undivided.
[3] Gyrogonite enclosed in utricle typically bilaterally symmetrical and composed of inner nodular layer and external structural layer formed of elongated units.
[4] Gyrogonite of Porocharaceae with pointed summit that is not, however, drawn into a neck.
[5] Gyrogonite of Porocharaceae with a truncate summit.
[6] Gyrogonites with superficial or slightly inserted opercular apical cells positioned in alignment with spiral ends.
[7] Gyrogonites with opercular apical cells in most instances superficial and alternating with spirals in position.
[8] Gyrogonites with superficial or slightly inserted opercular apical cells positioned in alignment with spiral ends.
[9] Gyrogonites with more than 5 sinistrally spiralled cells.
[10] Gyrogonites with sinistrally spiralled cells variable in number from 8 to 13.
[11] Gyrogonite with 6 to 7 sinistrally spiralled cells.
[12] Gyrogonites with 5 to 12 dextrally spiralled cells without transverse ridges.
[13] Gyrogonites with 8 to 9 dextrally spiralled cells and no coronula cells.
[14] Gyrogonites pear shaped, with dex-trally spiralled cells.
[15] Gyrogonites with 5 to 7 dextrally spiralled cells, equatorial angle of spirals less than 20°.
[16] Gyrogonites with 5 to 7 spiral cells, with no coronula cells, shape oblate or subglobular, apical and basal areas rounded to flat, apical pore smaller than basal pore.
[17] Gyrogonites of Moellerina type with 10 to 12 dextrally spiralled cells and no coronula cells.
[18] Gyrogonite pyriform or bottle shaped, with basal and apical areas truncated.
[0] spirals smooth or variously ornamented.
[0] spirals generally with tubercles or crests; ornamentation interrupted at periphery of apex.
[0] base rounded, truncated in center.
[0] apical pore variable in diameter; in some genera very small or even closed.
[0] spiral endings bearing 5 apical cells, joined in apex center and constituting deciduous operculum.
[0] equatorial angle of the spiral cells above 20°.
[0] shape subglobular, apical area rounded, pointed, or elongated to form a neck.</gyrogonite><pore>[0] Pore of dehiscence wide, in form of a cog wheel.
[1] Pores are outlets for internal canals.
[2] Pores at end of internal canals, generally opening at tip of lateral projections.</pore><spiral-cells>[0] Spiral cells smooth or variously ornamented.</spiral-cells><extant-species>[0] In extant species, 5 large noncalcified coronula cells in 1 tier;
[0] thallus corticated or not corticated.
[0] Extant species with 10 small uncalcified coronula cells in 2 tiers.
[1] In extant species, oogonia uncalcified, not laterally compressed, with 3 basal sister cells.</extant-species><apex-lamprothamnoid>[0] Apex lamprothamnoid with deep periapical furrow.</apex-lamprothamnoid><diameter>[0] Diameter of apical zone varying from 100 to 160 µm.
[1] Diameter of apical zone varying from 160 to 280 µm.</diameter><spiral>[0] Spirals turn onto truncate apex to form its outer rim, then bend down into central depression, finally turning sharply into center of summit depression and expanding to fill space;
[1] Spirals unornamented;
[2] Spirals not divided by transverse ridges;
[0] horizontal part of apex thin and transparent to swollen and bulbous.
[0] basal pore in some species at end of funnel-shaped depression.
[0] Spirals unornamented and with Y-calcification (see p. 10 herein).
[1] Spirals narrowing at periphery of apex, then widening again toward center without thickening.
[2] Spirals concave, smooth.
[0] basal area rounded, apical pore larger than basal pore.</spiral><spirals-smooth>[0] Spirals smooth, concave to gently convex.
[1] Spirals smooth or with irregular nodules.
[2] Spirals smooth or with tubercles.
[3] Spirals smooth or with tubercles.
[4] Spirals smooth.
[5] Spirals smooth.
[6] Spirals smooth or with tubercles or crests.
[7] Spirals smooth or with nodular crests.
[8] Spirals smooth.
[9] Spirals smooth, in numerous instances with sinuous spiral sutures.
[10] Spirals smooth.
[11] Spirals smooth or with tubercles.
[12] Spirals smooth or with tubercles.
[13] Spirals smooth, clearly widened and thickened in upper and lower parts.
[14] Spirals smooth, flat to convex.
[15] Spirals smooth or with tubercles.
[16] Spirals smooth.
[17] Spirals smooth or with nodules.
[18] Spirals smooth.</spirals-smooth><size>[0] Size small.
[1] Size medium to large.
[2] Size medium to large.
[3] Size small to medium.
[4] Size small to medium.
[5] Size medium to large.
[6] Size medium to large.
[7] Size large.
[8] Size small to large.
[9] Size medium to large.
[10] Size small.
[11] Size small.
[12] Size small to medium.
[13] Size medium.
[14] Size medium to large.
[15] Size small to medium.
[16] Size small to medium.
[17] Size generally small, in some species small to medium.
[18] Size medium.
[19] Size small.
[20] Size small.
[21] Size small to medium.
[22] Size medium to large.
[23] Size small to large.
[24] Size small.
[25] Size small to large.
[26] Size small to large.
[27] Size small to large.
[28] Size small to medium.
[29] Size small.
[30] Size medium to large.
[31] Size variable.
[32] Size medium to large.
[33] Size large.
[34] Size small.
[35] Size medium to large.
[36] Size medium to large.
[37] Size small.
[38] Size small.
[39] Size small to medium.
[40] Size generally small.
[41] Size very small.
[42] Size variable.
[43] Size variable.
[44] Size medium to large.
[45] Size medium to large.
[46] Size small to large.
[47] Size very large, up to 3 mm.</size><basal-plate>[0] Basal plate generally not described;
[1] Basal plate strongly calcified, thickness being more than half of width;
[0] in some species, basal plate multipartite (LU &amp; LUO, 1990).
[0] Basal plate as thick as wide, lower face visible from exterior.
[1] Basal plate pyramidal, its thickness being more than half of width.
[2] Basal plate conical, thickness being about half width.
[3] Basal plate prismatic, visible from exterior, thickness being more than half width.
[4] Basal plate very thick, higher than wide, not visible from exterior.
[5] Basal plate very thin, about ten times as wide as high.
[6] Basal plate unknown.
[7] Basal plate thin.
[8] Basal plate variable in thickness.
[9] Basal plate slightly wider than thick, visible from exterior.
[10] Basal plate conical, its thickness being about half of width.
[11] Basal plate prismatic, height and width approximately equal, visible from exterior.
[12] Basal plate unknown.
[13] Basal plate very thin, not visible from exterior.
[14] Basal plate variable in thickness, generally thinner than wide.
[15] Basal plate unknown.
[16] Basal plate twice as wide as high, generally visible from exterior.
[17] Basal plate very thin, not visible from the exterior.
[18] Basal plate thick, at least as thick as half of width, to thicker than wide, not visible from exterior.
[19] Basal plate nearly as thick as wide, generally visible from exterior.
[20] Basal plate as thick as about onethird width.
[21] Basal plate thick, the thickness up to twice width, visible or not from exterior.
[22] Basal plate slightly calcified, not visible from exterior.
[23] Basal plate wider than thick.
[24] Basal plate unknown.
[25] Basal plate slightly calcified, about one-third as thick as wide, with upper face hollow.
[26] Basal plate conical and hollow.
[27] Basal plate moderately thick.
[28] Basal plate nearly twice as wide as thick, visible from exterior.
[29] Basal plate multipartite (LU & LUO, 1990), as wide as thick, not visible from exterior.
[30] Basal plate variable in thickness, about half as thick as wide.
[31] Basal plate thicker than wide, not visible from exterior.
[32] Basal plate multipartite, thick.
[33] Basal plate nearly as wide as thick.
[34] Basal plate wider than thick, visible from exterior.
[35] Basal plate undivided, as thick as wide, with upper and lower faces commonly stellate, visible from exterior.
[36] Basal plate undivided or with 2 to 3 pieces.
[37] Basal plate multipartite or unknown.
[38] Basal plate weakly calcified, wider than high, and not visible from exterior.
[39] Basal plate not well calcified and not visible from exterior.
[40] Basal plate generally thick, higher than wide, visible from the exterior.
[41] Basal plate rounded, slightly projecting.
[0] lower face of plate visible from exterior.</basal-plate><apex-psilocharoid>[0] Apex psilocharoid, with spirals retaining their width but tending to flatten as they turn onto summit.</apex-psilocharoid><shape>[0] General shape subovoid with apical part gently rounded or slightly projecting;
[1] General shape ovoid or ellipsoid;
[2] General shape irregular, oblate-spheroidal to subprolate;
[3] General shape subprolate to prolate with apex rounded and its central part slightly prominent;
[4] General shape oblate to oblate-spheroidal;
[5] General shape subprolate, with apex rounded and base narrowed;
[6] General shape prolate spheroidal to subprolate, with apex center forming rounded or truncated cap;
[7] General shape prolate-spheroidal to prolate;
[8] General shape prolate to subprolate, with apex strongly protruding;
[9] General shape prolate spheroidal and often quadrangular, with rounded apex;
[10] General shape oblate, suboblate to oblate-spheroidal, with apex rounded or truncated;
[11] General shape prolate to subprolate, with apex rounded and base tapered;
[12] General shape prolate–spheroidal with apex protruded and base rounded;
[13] General shape prolatespheroidal to prolate;
[14] General shape prolate-spheroidal to subprolate;
[0] base tapered, basal pore at end of funnel-shaped depression; basal plate parallelepidal shaped, being generally less high than onequarter of width.
[1] base rounded.
[2] base rounded, in some species base slightly tapered.
[3] base rounded, with ends of spirals concave, sutures forming crests around pore.
[4] base rounded or slightly tapering, with flaring funnel.
[0] spirals smooth.
[0] General shape of gyrogonite ellipsoid to cylindroid, sometimes very elongated.
[1] General shape ovoidal with apex prominent and base tapered with tendency to form a broad column.
[2] General shape subprolate to perprolate, with apex truncated and base slightly narrowed.
[3] General shape subprolate, with apex rounded and base truncated.
[4] General shape subprolate, with apex rounded or pointed and base thinner.
[5] General shape prolate-spheroidal with apex truncated and base rounded.
[6] General shape variable, oblate-spheroidal to prolate, apex pointed and base rounded or truncated.
[7] General shape prolate to perprolate, with apex protruded and base tapered.
[8] General shape prolate-spheroidal to subprolate and subovoidal, with apex prominent and base rounded or tapered.
[9] General shape prolate-spheroidal to subprolate with apex rounded.
[10] General shape prolate-spheroidal to perprolate, with apex rounded or pointed and base rounded or tapered.
[11] General shape subprolate to ellipsoidal with summit truncated and base somewhat tapered.
[12] General shape spheroidal with apex pointed and base rounded.
[13] General shape ovoid with apex rounded, projecting above apical level.
[14] General shape prolatespheroidal to prolate and perprolate with apex protruding and base tapered.
[15] General shape cylindrical with apex and base truncated.
[16] General shape of gyrogonite ovoid with truncated summit and tapering base.
[17] General shape spheroidal to prolate-spheroidal.
[18] General shape spheroidal with apex and base pointed.
[19] General shape perprolate, with apex and base truncated.
[20] General shape spheroidal to prolate, with apex truncated and base rounded or tapered.
[21] General shape prolate-spheroidal to prolate, with apex truncated and base truncated or tapered.
[22] Shape bulbiform.
[23] General shape subglobular to ovoid, apical pore large.
[24] General shape globular, coronula units forming erect, parapet-like ring around large summit opening.
[0] apex rounded, strongly prominent.
[1] apex and base rounded or truncated; spirals with tubercles or crests, continuing up to apex with small break in periapical zone.
[2] apex rounded, prominent in center, base tapered.
[3] apex nearly flat to broadly conical, base truncated.
[4] apex rounded or truncated, central part variably prominent; base tapering to point or column.
[0] in some species base projecting.
[1] in some species base ta-pered.
[0] base similar or, in numerous instances, spirals turned downward around basal pore to form small cone or distinct column.
[0] basal column axis slightly curved with respect to polar axis.</shape><apex>[0] Apex nitellopsidoid;
[1] Apex psilocharoid, convex, with cellular apical ends enlarged, generally shaped into a cap without apical nodules;
[2] Apex psilocharoid;
[3] Apex psilocharoid;
[4] Apex lamprothamnoid;
[5] Apex lamprothamnoid, with shallow periapical depression;
[6] Apex nitellopsidoid;
[7] Apex nitellopsidoid;
[8] Apex psilocharoid;
[9] Apex nitellopsidoid;
[10] Apex psilocharoid, convex, without periapical modification;
[11] Apex psilocharoid;
[12] Apex psilocharoid, with distinct periapical narrowing and thinning;
[13] Apex nitellopsidoid, with shallow periapical groove;
[14] Apex nitellopsidoid, with deep depression and no constrictions at apical periphery;
[0] at periphery of apex, spiral cells becoming markedly thinner and narrower, producing distinct furrow that surrounds prominent rosette made of swollen endings.
[0] in ornamented species (occurring as fossils) apical tubercles present, similar to those of lateral parts of gyrogonite.
[0] apical endings slightly thickened, without appreciable peripheral thinning and narrowing.
[0] spirals barely thinner as they pass onto summit then slightly thickened at center.
[1] spirals become thinner as they pass onto summit, then thicken again, ascending to center of apex.
[2] spirals with distinct periapical narrowing and thinning, with ends thickening and expanding, forming prominent central rosette.
[3] spirals with distinct periapical narrowing and thinning, thickening and expanding at ends to form prominent central rosette.
[4] spirals convex, becoming concave with high, intercellular crests in apical zone and turning up in center.
[0] Apex nitellopsidoid.
[1] Apex psilocharoid.
[2] Apex psilocharoid.
[3] Apex lamprothamnoid, with deep, periapical furrow and central part convex, not overtopping general surface.
[4] Apex psilocharoid with thinning of entire apical zone.
[5] Apex lamprothamnoid, with deep periapical furrow.
[6] Apex psilocharoid.
[7] Apex psilocharoid with periapical furrow.
[8] Apex psilocharoid, without distinct differentiation.
[9] Apex psilocharoid, with apical spiral endings not enlarged or only slightly enlarged.
[10] Apex psilocharoid, with little or no modification.
[11] Apex lamprothamnoid, with spirals narrowing and thinning on apex periphery, then slightly widening and thickening somewhat in apex center, without forming distinct nodules.
[12] Apex psilocharoid, without notable modifications.
[13] Apex nitellopsidoid, with distinct periapical thinning and variable narrowing of spirals.
[14] Apex nitellopsidoid, with periapical furrow weakly marked and variable narrowing of spirals.
[15] Apex psilocharoid, without distinct apical modifications of spirals but with slight enlargement at ends.
[16] Apex psilocharoid, with spirals somewhat thinned in apical zone, particularly on apex periphery.
[17] Apex lamprothamnoid, with peripheral spiral thinning weak or absent.
[18] Apex psilocharoid, with apical ends of spirals thickened.
[19] Apex psilocharoid, with spirals unmodified at apex.
[20] Apex lamprothamnoid, with apical rosette in well-marked depression bearing slightly convex nodules in center.
[21] Apex nitellopsidoid, with slight narrowing and no depression of spiral cells in periapical zone.
[22] Apex curved, with central rosette.
[23] Apex without distinct modifications.
[24] Apex flat.
[25] Apex protruding.
[0] in apex center, spirals thin and turn up, forming conical protuberance.
[0] periapical zone variably thinned and slightly or not narrowed.
[0] spiral ends slightly enlarged.
[0] apical zone thin but convex; weakly marked apical nodules rarely present.
[0] apical ends of spirals slightly pointed in center, without nodules.
[0] apical nodules rounded, moderately thick.
[1] apical nodules strongly developed.</apex><rejected-genus>[0] Rejected genus.
[1] Rejected genus.
[2] Rejected genus.
[3] Rejected genus.</rejected-genus><gyrogonite-spheroidal>[0] Gyrogonite spheroidal to subprolate, with short, broad apical neck;
[1] Gyrogonite spheroidal;
[0] number of convolutions high (more than 10); spirals smooth, concave to flat.
[0] spirals smooth or in some species bearing well-calcified rods even in apical part.</gyrogonite-spheroidal><base-rounded>[0] Base rounded or slightly pointed.
[1] Base rounded, in some species tapering.</base-rounded><deep-periapical>[0] Deep periapical furrow without notable narrowing of spirals, surrounding prominent rosette of well-marked nodules.</deep-periapical><base>[0] Base rounded;
[0] in some species, basal pore surrounded by widened funnel.
[0] Base tapering, sometimes forming wellmarked basal column.</base><incompletely-known>[0] Incompletely known genus, referable either to Sphaerochara or Tolypella, according to the basal-plate morphology.</incompletely-known><spiral-numerous>[0] Spirals numerous, unornamented, without modifications in apical part.</spiral-numerous><basal-plug>[0] Basal plug pentagonal, slightly wider than high, projecting out of basal pore.</basal-plug><gyrogonite-stem>[0] Gyrogonite stem shaped, lower part being abruptly narrowed and forming column with truncated ending.</gyrogonite-stem><differ>[0] Differs from other genera by peculiar gyrogonite shape.
[1] [Differs from Tectochara mostly in the characters of the basal part and not by the presence of an ornamentation as stated in MÄDLER diagnosis] The presence of this genus in the Neogene is questionable, the apical structure of ?N. globosa S. WANG, 1961, being unknown, and thus its attribution to Nodosochara is.</differ><genus-based>[0] Genus based essentially on gyrogonite ornamentation.</genus-based><original-material>[0] The original material has been lost.</original-material><gyrogonite-described>[0] Gyrogonites described as bottle shaped and enclosed by vegetative parts.</gyrogonite-described><spiral-thin>[0] Spirals thin or absent at apical center.</spiral-thin><preserved-apical-parts-of-spirals-concave-turning-up-sharply-into-apex-center>[0] When preserved, apical parts of spirals concave, turning up sharply into apex center.</preserved-apical-parts-of-spirals-concave-turning-up-sharply-into-apex-center><apical-ends>[0] Apical ends of spirals concave, in some instances with poorly developed nodules.</apical-ends><gyrogonites>[0] Gyrogonites often with tubercles or crests, ornamentation reaching apex center.
[1] Gyrogonites with 5 sinistrally spiralled cells, enclosed in utricle, made of generally calcified cells of vegetative origin.
[2] Gyrogonites with apical pore at end of neck or collar.</gyrogonites><spirals-occasionally>[0] Spirals occasionally with surface ornamentation, especially secondary ridges or small cellular tubercles.</spirals-occasionally><convolution-numerous>[0] Convolutions numerous (11–14), without ornamentation.</convolution-numerous><monospecific-genus>[0] Monospecific genus.
[1] Monospecific genus.</monospecific-genus><genus-distinction>[0] Genus distinction based only on apical projections, which represent abnormal calcified apical cellular ends.</genus-distinction><referable>[0] Might be referable to Chara.</referable><correspond>[0] Corresponds to nodosoclavatoroid utricles, as recognized from the nodular surface and from the presence of gyrogonite cells inside (Lu &amp; Yuan, 1991, pl. I,11).</correspond><spiral-generally>[0] Spirals generally unornamented;
[1] Spirals generally smooth;
[0] however, some species have thick, intercellular, prominent ridges.
[0] in some species, spirals with wavy or nodular crest.
[0] Spirals generally with tubercles, rods, or crests.
[1] Spirals generally concave, smooth or with transverse rods.
[2] Spirals generally convex, smooth.</spiral-generally><basal-funnel>[0] Basal funnel present, basal plate thicker than half width, visible from exterior.
[1] Basal funnel present.
[2] Basal funnel star shaped, sometimes absent.</basal-funnel><apical-nodules>[0] Apical nodules present, generally elongated.
[1] Apical nodules prominent, grouped into apical rose.</apical-nodules><apical-node>[0] Apical nodes convex and elongated;
[0] in some species, apical nodes absent.</apical-node><apex-center>[0] In apex center, spiral endings abruptly arise and form projecting cone.</apex-center><spiral-flat>[0] Spirals flat to slightly convex with elongated, tumorlike decorations.</spiral-flat><basal-pore>[0] Basal pore small;
[0] basal funnel absent.</basal-pore><immature-specimen>[0] Immature specimens reminiscent of Aclistochara.</immature-specimen><apical-zone>[0] Apical zone sunken.</apical-zone><gyrogonite-ellipsoid>[0] Gyrogonite ellipsoid, with apex rounded and base tapering.</gyrogonite-ellipsoid><uncalcified-oogonium>[0] Uncalcified oogonia of Nitella and Tolypella are only occasionally fossilized.</uncalcified-oogonium><thallus>[0] Thallus not corticated, uncalcified.</thallus><enveloping-cell>[0] Enveloping cells do not secrete calcite, thus gyrogonites do not occur.</enveloping-cell><oogonium>[0] Oogonia and oospore small, laterally compressed, with 3 basal sister cells.</oogonium><well-calcified-specimen>[0] In well-calcified specimens, spirals become thinner in periapical zone, then recover thickness at ends.</well-calcified-specimen><spirals>[0] Spirals in most instances with granulate surface.</spirals><present-ornamentation-consisting-of-constriction-and-irregular-elongated-nodules>[0] When present, ornamentation consisting of constrictions and irregular, elongated nodules.</present-ornamentation-consisting-of-constriction-and-irregular-elongated-nodules><fossil-species>[0] In fossil species, uncalcified forms unknown;
[0] calcified gyrogonites with bipartite or tripartite basal plate.</fossil-species><similarly-branched>[0] 3 or 6 similarly branched units of internal group trifurcately ramified, whereas external group more variable or even completely reduced.</similarly-branched><group>[0] Each group composed of 3 units at base, with 5 units resting on them.</group><type-species>[0] Type species unique in having only 15 units, 3 basal units not represented.</type-species><external-layer>[0] External layer not developed in some genera.
[1] External layer made of vertical units except in apical zone where furrows radiate from accessory pores.</external-layer><specialized-genera>[0] Some specialized genera develop secondary triradiate or four-rayed symmetry.</specialized-genera><pore-opening>[0] A pore opening at end of horn.</pore-opening><utricle-bilaterally>[0] Utricle bilaterally symmetrical with 2 calcified layers, inner smooth or nodular, outer made of 12 or fewer elongated vertical or spiralled units.
[1] Utricle bilaterally symmetrical, with 2 opposite shields, each composed of 9 to 13 superficial units radiating from 2 lateral pores.
[2] Utricle bilaterally symmetrical, with 2 accessory pores located at top of shoulders of apex.</utricle-bilaterally><vegetative-apparatus>[0] Vegetative apparatus strongly calcified, with central tube surrounded by 12 dextrally coiled cortical tubes composed of alternate long and short units, latter giving rise to clusters of spines that more or less completely cover cortex.</vegetative-apparatus><side>[0] On 1 or 2 sides, 2 or 3 cells are intercalated between basal cell and lateral pore.</side><lateral-pore>[0] Lateral pores are outlets for internal canals originating from basal chamber.</lateral-pore><outer-layer>[0] Outer layer with numerous vertical, long units in basal part of utricle.</outer-layer><apical-part>[0] Apical part composed of shorter units converging to apical pore.
[1] Apical part of gyrogonite protrudes into beak, conical to very elongated.</apical-part><horizontal-corticated>[0] A horizontal corticated tube, weakly developed in H. campylopoda, joined to basal part of utricle.</horizontal-corticated><accessory-pore>[0] Accessory pores are outlets for 2 internal canals originating at basal chamber.</accessory-pore><adaxial-face>[0] Adaxial face of utricle joined to fragment of branch or with prominent furrow marking its place.</adaxial-face><apical-pore>[0] Apical pore sunken.
[1] Apical pore rounded, pentagonal, or stellatiform.
[2] Apical pore present.
[3] Apical pore present.
[4] Apical pore small.</apical-pore><apical-opening>[0] Apical opening small or medium;
[1] Apical opening small to medium;
[2] Apical opening fairly large and ranging from strongly stellate to almost round;
[0] basal plate undivided; general shape varying from ellipsoidal to subglobular.
[0] spiral ends sometimes bending toward center of apical pore; basal plate multipartite; general shape varying from ellipsoidal to subglobular.
[0] gyrogonites taper and may possess beak with small, truncate, apical area; basal plate undivided (PECK &amp; EYER, 1963b, pl. 101,6).</apical-opening><apical-area>[0] Apical area drawn into an elongated neck;
[0] apical pore small or closed.</apical-area><basal-area>[0] Basal area rounded, basal pore large.</basal-area><cell-number>[0] Cell number unknown.</cell-number><gyrogonite-incompletely>[0] Gyrogonites incompletely known.</gyrogonite-incompletely><presence>[0] Presence of a utricle, composed of vertical or dextrally spiralled cells, or ramified branches.</presence><utricles>[0] Utricles with 3 to 14 vertical units that are simple or divided only at apical end.</utricles><utricle>[0] Utricles with 3 to 4, long and thick, slightly dextrally spiralled units, not reaching apex;
[1] Utricles with 5 to 8 long vertical units, basal pore closed by discoid plate;
[2] Utricles bilaterally symmetrical;
[3] Utricles bilaterally symmetrical, with 12 to 22 vertical cells divided into small polygonal pits by transverse ridges;
[4] Utricle with numerous, often 18, dextrally spiralled cells that are simple or subdivided by numerous transverse ridges;
[5] Utricles with 18 dextrally spiralled cells, with no coronula cells;
[0] apical pore large, basal pore closed by discoid plate.
[1] apical pore usually open.
[0] summit opening occasionally surrounded and extended by short neck composed of separate apical cells equal in number to vertical cells.
[0] Utricles with vertical units arranged in a symmetrical branching sequence.
[1] Utricle made of numerous long cells that may be vertical or dextrally spiralled and are divided or not by numerous horizontal ridges creating polygonal pits.
[2] Utricles with 7 to 10 dextrally spiralled cells and an equal number of calcified coronula cells.
[0] each face bearing one group of long vertical furrows and four branching short furrows obliquely directed upward; adjacent branching furrows overlapping each other and forming sawtooth ridges at their junction.
[0] division of vertical units around base follow determinate pattern.
[0] spirals occasionally divided by transverse ridges, shape subglobular to oblate, apical region flattened or depressed, apical pore larger than basal; basal pore sometimes surrounded by 2 bisymmetrical, lip-shaped protuberances.</utricle><gyrogonite-visible>[0] Gyrogonites visible from exterior, at summit and laterally, between utricle units.</gyrogonite-visible><apical-cell>[0] Apical cells occasionally missing.</apical-cell><vertical-unit>[0] Vertical units, simple or bifurcating, up to 9 to 14 in number, going up to apical pore without intermediate apical cells.</vertical-unit><small-pore>[0] Small pores representing apertures of internal canals present at utricle surface.</small-pore><multilayered-wall>[0] Multilayered wall of utricle visible in thin sections.</multilayered-wall>"
";
    System.out.print(markNonspecified(string));
    ElementComposite ec = new ElementComposite();
    String dir = args[0];
    String modelfile = args[1];
    String alg = args[2];

    //String dir = "C:\\Documents and Settings\\hong cui\\ThesisProject\\Exp\\level1\\trainingdir-fna630-merged-bysent-level1-stratified\\";
    //String dir = "C:\\Documents and Settings\\hong cui\\ThesisProject\\Exp\\level1\\trainingdir-fnct300\\";
    //String dir = "/home/hongcui/ThesisProject/Exp/level1/trainingdir-foc500-merged-bysent-level1-standardized/";
    //String dir = "C:\\Documents and Settings\\hong cui\\ThesisProject\\Exp\\level2\\trainingdir-fna630-merged-bysent-level2-stratified\\";
    //String dir = "C:\\Documents and Settings\\hong cui\\ThesisProject\\Exp\\level2\\trainingdir-foc500-merged-bysent-level2-standardized\\";
    //String alg = "SCCP";

    File srcdir = new File(dir);
    File[] filelist = srcdir.listFiles();
    for (int i = 0; i < filelist.length; i++) {
      String xml = learning.Utilities.readFile(filelist[i]);
      xml = KFold.removeTaxon(xml);
      if (xml.trim().compareTo("") != 0) {
        ec.addTrain(xml, filelist[i].getName());
      }
    }
    if (alg.compareTo("NB") == 0 || alg.compareTo("CT") == 0 ||
        alg.compareTo("LW") == 0 || alg.compareTo("LWI") == 0) {
      //switch: VisitorLearnLessStructured or VisitorLearnSemiStructured
      ec.accept(new VisitorLearnLessStructured(), alg);
    }
    else {
      ec.accept(new VisitorLearnSemiStructured(), alg);
    }
    //serialize ec
    try {
      /*Serializer.serialization( (String) (ec.getModel().
                                          getClass().getDeclaredField(
          "modelfile")).get(null), ec);*/
      Serializer.serialization(modelfile, ec);
    }
    catch (SecurityException ex1) {
    }
    /*catch (NoSuchFieldException ex1) {
    }
    catch (IllegalAccessException ex1) {
    }*/
    catch (IllegalArgumentException ex1) {
    }
  }

}
